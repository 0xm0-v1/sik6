#!/usr/bin/env sh

set -eu

REPO_ROOT="$(git rev-parse --show-toplevel)"
FRONTEND_DIR="$REPO_ROOT/frontend"

echo "▶ Running formatters (lint-staged for FE)…"
npx --yes lint-staged --cwd "$FRONTEND_DIR" || {
  echo "❌ lint-staged failed. Fix formatting before committing."
  exit 1
}

echo "▶ Running gofumpt on staged Go files…"
GO_FILES="$(git diff --name-only --cached -- 'backend/**/*.go' || true)"
if [ -n "${GO_FILES:-}" ]; then
  if ! command -v gofumpt >/dev/null 2>&1; then
    echo "⚠️ gofumpt not found. Install with: go install mvdan.cc/gofumpt@latest"
    exit 1
  fi
  echo "$GO_FILES" | while IFS= read -r f; do
    [ -n "$f" ] || continue
    gofumpt -w "$REPO_ROOT/$f" || exit 1
    git add "$f"
  done
fi

echo "▶ Running Go lints…"
make -C backend lint || {
  echo "❌ Go linting failed."
  exit 1
}

echo "▶ Running ESLint…"
npm --prefix "$FRONTEND_DIR" run lint || {
  echo "❌ ESLint failed."
  exit 1
}

echo "✅ Pre-commit checks passed."
